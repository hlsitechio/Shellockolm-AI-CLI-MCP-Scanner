name: CVE Monitor - React Security Alerts

on:
  schedule:
    # Run daily at 9 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  check-react-cves:
    name: Monitor React CVEs
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Check NVD for new React CVEs
      id: check_cves
      run: |
        python << 'EOF'
        import requests
        import json
        from datetime import datetime, timedelta

        # Check for React CVEs in last 7 days
        days_back = 7
        date_from = (datetime.now() - timedelta(days=days_back)).strftime('%Y-%m-%d')

        # NVD API endpoint
        url = f"https://services.nvd.nist.gov/rest/json/cves/2.0"
        params = {
            "keywordSearch": "react",
            "pubStartDate": f"{date_from}T00:00:00.000",
            "resultsPerPage": 20
        }

        print(f"Checking for React CVEs since {date_from}...")

        try:
            response = requests.get(url, params=params, timeout=30)
            response.raise_for_status()
            data = response.json()

            vulnerabilities = data.get('vulnerabilities', [])

            if vulnerabilities:
                print(f"Found {len(vulnerabilities)} potential React CVEs")
                with open('new_cves.json', 'w') as f:
                    json.dump(vulnerabilities, f, indent=2)
                print("found_cves=true")
            else:
                print("No new React CVEs found")
                print("found_cves=false")

        except Exception as e:
            print(f"Error checking CVEs: {e}")
            print("found_cves=error")
        EOF

    - name: Parse CVE data
      if: hashFiles('new_cves.json') != ''
      id: parse
      run: |
        python << 'EOF'
        import json

        try:
            with open('new_cves.json', 'r') as f:
                vulns = json.load(f)

            for vuln in vulns:
                cve = vuln.get('cve', {})
                cve_id = cve.get('id', 'Unknown')
                descriptions = cve.get('descriptions', [])
                desc = descriptions[0].get('value', 'No description') if descriptions else 'No description'

                # Check if it's actually about React (not just keyword match)
                if 'react' in desc.lower() or 'facebook/react' in desc.lower():
                    print(f"\nNew CVE found: {cve_id}")
                    print(f"Description: {desc[:200]}...")

                    # Get CVSS score if available
                    metrics = cve.get('metrics', {})
                    cvss_v31 = metrics.get('cvssMetricV31', [])
                    if cvss_v31:
                        score = cvss_v31[0].get('cvssData', {}).get('baseScore', 'N/A')
                        severity = cvss_v31[0].get('cvssData', {}).get('baseSeverity', 'N/A')
                        print(f"CVSS: {score} ({severity})")
        except Exception as e:
            print(f"Error parsing CVEs: {e}")
        EOF

    - name: Create issue for new CVEs
      if: hashFiles('new_cves.json') != ''
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          // Read CVE data
          let vulns = [];
          try {
            const data = fs.readFileSync('new_cves.json', 'utf8');
            vulns = JSON.parse(data);
          } catch (e) {
            console.log('No new CVEs to process');
            return;
          }

          for (const vuln of vulns) {
            const cve = vuln.cve || {};
            const cveId = cve.id || 'Unknown';
            const descriptions = cve.descriptions || [];
            const desc = descriptions[0]?.value || 'No description';

            // Only create issue if it's actually about React
            if (desc.toLowerCase().includes('react') || desc.toLowerCase().includes('facebook/react')) {

              // Get CVSS score
              const metrics = cve.metrics || {};
              const cvssV31 = metrics.cvssMetricV31 || [];
              const cvssScore = cvssV31[0]?.cvssData?.baseScore || 'N/A';
              const severity = cvssV31[0]?.cvssData?.baseSeverity || 'N/A';

              // Get published date
              const published = cve.published || 'Unknown';

              // Create issue body
              const issueBody = `
          ## New React CVE Detected: ${cveId}

          **CVSS Score**: ${cvssScore} (${severity})
          **Published**: ${published}

          ### Description
          ${desc}

          ### Action Required

          - [ ] Review CVE details at [NVD](https://nvd.nist.gov/vuln/detail/${cveId})
          - [ ] Check if our scanner detects this vulnerability
          - [ ] Update scanner if needed to detect this CVE
          - [ ] Update remediation logic with patch versions
          - [ ] Update documentation with new CVE information
          - [ ] Test automated patching for this CVE
          - [ ] Notify users about new vulnerability

          ### Quick Links

          - [CVE Details](https://www.cve.org/CVERecord?id=${cveId})
          - [NVD Entry](https://nvd.nist.gov/vuln/detail/${cveId})
          - [React Security](https://react.dev/blog)

          ---

          *This issue was automatically created by CVE monitoring workflow*
          *Triggered on: ${new Date().toISOString()}*
              `;

              // Check if issue already exists
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
                labels: 'cve-alert'
              });

              const exists = existingIssues.data.some(issue =>
                issue.title.includes(cveId)
              );

              if (!exists) {
                // Create new issue
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `ðŸš¨ New React CVE: ${cveId} - ${severity}`,
                  body: issueBody,
                  labels: ['cve-alert', 'security', severity.toLowerCase()]
                });

                console.log(`Created issue for ${cveId}`);
              } else {
                console.log(`Issue already exists for ${cveId}`);
              }
            }
          }

  check-react-releases:
    name: Monitor React Security Releases
    runs-on: ubuntu-latest

    steps:
    - name: Check React releases
      run: |
        # Check React GitHub releases for security patches
        curl -s https://api.github.com/repos/facebook/react/releases?per_page=5 | \
        jq -r '.[] | select(.name | contains("security") or contains("Security") or contains("CVE")) |
        "Release: \(.name)\nPublished: \(.published_at)\nURL: \(.html_url)\n---"'

    - name: Check Next.js releases
      run: |
        # Check Next.js GitHub releases for security patches
        curl -s https://api.github.com/repos/vercel/next.js/releases?per_page=5 | \
        jq -r '.[] | select(.name | contains("security") or contains("Security") or contains("CVE")) |
        "Release: \(.name)\nPublished: \(.published_at)\nURL: \(.html_url)\n---"'
