"""
Comprehensive Vulnerability Database
Tracks all known React, Next.js, and NPM vulnerabilities
"""

from dataclasses import dataclass
from typing import List, Optional, Dict
from packaging import version


@dataclass
class Vulnerability:
    """Represents a security vulnerability"""
    cve_id: str
    title: str
    severity: str  # CRITICAL, HIGH, MEDIUM, LOW
    cvss_score: float
    affected_package: str
    affected_versions: List[str]
    patched_versions: Dict[str, str]  # vulnerable_version -> patched_version
    description: str
    references: List[str]
    discovered_date: Optional[str] = None


class VulnerabilityDatabase:
    """Comprehensive database of known vulnerabilities"""

    # React vulnerabilities
    REACT_VULNERABILITIES = [
        Vulnerability(
            cve_id="CVE-2025-55182",
            title="React Server Components RCE",
            severity="CRITICAL",
            cvss_score=10.0,
            affected_package="react",
            affected_versions=["19.0.0", "19.1.0", "19.1.1", "19.2.0"],
            patched_versions={
                "19.0.0": "19.0.1",
                "19.1.0": "19.1.2",
                "19.1.1": "19.1.2",
                "19.2.0": "19.2.1",
            },
            description="Deserialization of untrusted data in Server Components",
            references=[
                "https://www.cve.org/CVERecord?id=CVE-2025-55182",
                "https://react.dev/blog/2025/12/03/critical-security-vulnerability-in-react-server-components",
            ],
            discovered_date="2025-11-29"
        ),
        Vulnerability(
            cve_id="CVE-2025-66478",
            title="React Server Components RCE (Duplicate)",
            severity="CRITICAL",
            cvss_score=10.0,
            affected_package="react",
            affected_versions=["19.0.0", "19.1.0", "19.1.1", "19.2.0"],
            patched_versions={
                "19.0.0": "19.0.1",
                "19.1.0": "19.1.2",
                "19.1.1": "19.1.2",
                "19.2.0": "19.2.1",
            },
            description="Same as CVE-2025-55182 - Vercel advisory duplicate",
            references=[
                "https://www.cve.org/CVERecord?id=CVE-2025-66478",
                "https://github.com/vercel/next.js/security/advisories/GHSA-9qr9-h5gf-34mp",
            ],
            discovered_date="2025-12-03"
        ),
        # Add more React CVEs as they're discovered
    ]

    # Next.js vulnerabilities
    NEXTJS_VULNERABILITIES = [
        Vulnerability(
            cve_id="CVE-2025-66478",
            title="Next.js Server Components RCE",
            severity="CRITICAL",
            cvss_score=10.0,
            affected_package="next",
            affected_versions=[
                "15.0.0", "15.0.1", "15.0.2", "15.0.3", "15.0.4",
                "15.1.0", "15.1.1", "15.1.2", "15.1.3", "15.1.4", "15.1.5", "15.1.6", "15.1.7", "15.1.8",
                "15.2.0", "15.2.1", "15.2.2", "15.2.3", "15.2.4", "15.2.5",
                "15.3.0", "15.3.1", "15.3.2", "15.3.3", "15.3.4", "15.3.5",
                "15.4.0", "15.4.1", "15.4.2", "15.4.3", "15.4.4", "15.4.5", "15.4.6", "15.4.7",
                "15.5.0", "15.5.1", "15.5.2", "15.5.3", "15.5.4", "15.5.5", "15.5.6",
                "16.0.0", "16.0.1", "16.0.2", "16.0.3", "16.0.4", "16.0.5", "16.0.6",
            ],
            patched_versions={
                "15.0.x": "15.0.5",
                "15.1.x": "15.1.9",
                "15.2.x": "15.2.6",
                "15.3.x": "15.3.6",
                "15.4.x": "15.4.8",
                "15.5.x": "15.5.7",
                "16.0.x": "16.0.7",
            },
            description="React Server Components deserialization vulnerability",
            references=[
                "https://github.com/vercel/next.js/security/advisories/GHSA-9qr9-h5gf-34mp",
            ],
            discovered_date="2025-12-03"
        ),
        # Add more Next.js CVEs here
    ]

    # NPM malware indicators
    MALWARE_INDICATORS = {
        # Shai Hulud campaign
        'shai_hulud': {
            'severity': 'CRITICAL',
            'description': 'Shai Hulud npm malware campaign',
            'packages': [
                '@postman/security-helpers',
                '@posthog/plugin-geoip',
                '@asyncapi/openapi-schema-parser',
                '@ensdomains/content-hash',
                '@zapier/secret-scrubber',
            ],
            'indicators': [
                'bun_environment.js',
                'setup_bun.js',
                'cloud.json',
                'truffleSecrets.json',
                '.truffler-cache',
                'trufflehog',
            ],
            'references': [
                'https://socket.dev/blog/shai-hulud-npm-malware-campaign',
            ]
        },
        # Other malware campaigns
        'suspicious_scripts': {
            'severity': 'HIGH',
            'description': 'Suspicious preinstall/postinstall scripts',
            'patterns': [
                'preinstall.*curl',
                'postinstall.*wget',
                'preinstall.*base64',
                'install.*eval',
            ],
        },
    }

    @staticmethod
    def get_all_react_vulnerabilities() -> List[Vulnerability]:
        """Get all known React vulnerabilities"""
        return VulnerabilityDatabase.REACT_VULNERABILITIES

    @staticmethod
    def get_all_nextjs_vulnerabilities() -> List[Vulnerability]:
        """Get all known Next.js vulnerabilities"""
        return VulnerabilityDatabase.NEXTJS_VULNERABILITIES

    @staticmethod
    def check_react_version(react_version: str) -> List[Vulnerability]:
        """Check if a React version has known vulnerabilities"""
        vulnerabilities = []
        clean_version = react_version.lstrip("^~>=<").split()[0]

        for vuln in VulnerabilityDatabase.REACT_VULNERABILITIES:
            if clean_version in vuln.affected_versions:
                vulnerabilities.append(vuln)

        return vulnerabilities

    @staticmethod
    def check_nextjs_version(nextjs_version: str) -> List[Vulnerability]:
        """Check if a Next.js version has known vulnerabilities"""
        vulnerabilities = []
        clean_version = nextjs_version.lstrip("^~>=<").split()[0]

        for vuln in VulnerabilityDatabase.NEXTJS_VULNERABILITIES:
            if clean_version in vuln.affected_versions:
                vulnerabilities.append(vuln)

        return vulnerabilities

    @staticmethod
    def get_patched_version(package: str, current_version: str, cve_id: str) -> Optional[str]:
        """Get the patched version for a vulnerable package"""
        vulnerabilities = []

        if package == "react":
            vulnerabilities = VulnerabilityDatabase.REACT_VULNERABILITIES
        elif package == "next":
            vulnerabilities = VulnerabilityDatabase.NEXTJS_VULNERABILITIES

        for vuln in vulnerabilities:
            if vuln.cve_id == cve_id:
                clean_version = current_version.lstrip("^~>=<").split()[0]

                # Direct match
                if clean_version in vuln.patched_versions:
                    return vuln.patched_versions[clean_version]

                # Range match (e.g., "15.0.x")
                parts = clean_version.split(".")
                if len(parts) >= 2:
                    range_key = f"{parts[0]}.{parts[1]}.x"
                    if range_key in vuln.patched_versions:
                        return vuln.patched_versions[range_key]

        return None

    @staticmethod
    def get_vulnerability_summary() -> Dict:
        """Get a summary of all vulnerabilities in the database"""
        return {
            "total_cves": len(VulnerabilityDatabase.REACT_VULNERABILITIES) +
                         len(VulnerabilityDatabase.NEXTJS_VULNERABILITIES),
            "react_cves": len(VulnerabilityDatabase.REACT_VULNERABILITIES),
            "nextjs_cves": len(VulnerabilityDatabase.NEXTJS_VULNERABILITIES),
            "malware_campaigns": len(VulnerabilityDatabase.MALWARE_INDICATORS),
            "critical_cves": sum(1 for v in VulnerabilityDatabase.REACT_VULNERABILITIES +
                                VulnerabilityDatabase.NEXTJS_VULNERABILITIES
                                if v.severity == "CRITICAL"),
        }


if __name__ == "__main__":
    # Example usage
    db = VulnerabilityDatabase()

    # Check a React version
    react_vulns = db.check_react_version("19.0.0")
    print(f"React 19.0.0 vulnerabilities: {len(react_vulns)}")
    for vuln in react_vulns:
        print(f"  - {vuln.cve_id}: {vuln.title} (CVSS: {vuln.cvss_score})")

    # Check a Next.js version
    next_vulns = db.check_nextjs_version("15.0.3")
    print(f"\nNext.js 15.0.3 vulnerabilities: {len(next_vulns)}")
    for vuln in next_vulns:
        print(f"  - {vuln.cve_id}: {vuln.title} (CVSS: {vuln.cvss_score})")

    # Get summary
    summary = db.get_vulnerability_summary()
    print(f"\nDatabase Summary:")
    print(f"  Total CVEs: {summary['total_cves']}")
    print(f"  Critical: {summary['critical_cves']}")
    print(f"  Malware Campaigns: {summary['malware_campaigns']}")
